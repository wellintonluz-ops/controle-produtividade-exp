<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Produtividade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-active {
            background-color: #4f46e5;
            color: white;
        }
        .tab-inactive {
            background-color: #374151;
            color: #d1d5db;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        @media print {
            body {
                background-color: white !important;
                color: black !important;
                font-size: 10pt;
            }
            .no-print {
                display: none !important;
            }
            main > div.hidden {
                display: none !important;
            }
            main > div {
                display: block !important;
            }
            .bg-gray-800, .bg-gray-900 {
                background-color: transparent !important;
                box-shadow: none !important;
                border: 1px solid #e5e7eb;
            }
            .text-white, .text-gray-200, .text-gray-300, .text-gray-400, .text-gray-300, .text-xs {
                color: black !important;
            }
            .text-red-400 { color: #dc2626 !important; }
            .text-yellow-400 { color: #f59e0b !important; }
            .text-green-400 { color: #10b981 !important; }
            .border-gray-700 { border-color: #e5e7eb !important; }
            .table-container {
                max-height: none;
                overflow: visible;
            }
            .grid, .bg-gray-800 {
                page-break-inside: avoid;
            }
            canvas {
                max-width: 100% !important;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Controle de Produtividade</h1>
            <p class="text-gray-400 mt-2">Cadastre suas atividades e registre seus lançamentos para acompanhar o desempenho.</p>
        </header>

        <!-- Botão de Impressão -->
        <div class="flex justify-end mb-4 no-print">
            <button id="btn-imprimir" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                </svg>
                Imprimir Página
            </button>
        </div>


        <!-- Abas de Navegação -->
        <div class="flex justify-center mb-8 space-x-2 md:space-x-4 no-print">
            <button id="tab-lancamentos" class="py-2 px-4 rounded-md font-semibold transition-colors duration-300 tab-active">Lançamentos</button>
            <button id="tab-cadastros" class="py-2 px-4 rounded-md font-semibold transition-colors duration-300 tab-inactive">Cadastros</button>
            <button id="tab-dashboards" class="py-2 px-4 rounded-md font-semibold transition-colors duration-300 tab-inactive">Dashboards</button>
        </div>

        <!-- Conteúdo Principal -->
        <main>
            <!-- Seção de Lançamentos -->
            <div id="content-lancamentos">
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg no-print">
                    <h2 class="text-2xl font-bold mb-6 text-white border-b border-gray-700 pb-2">Novo Lançamento</h2>
                    <form id="form-lancamento" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div>
                            <label for="data" class="block mb-2 text-sm font-medium text-gray-300">Data</label>
                            <input type="date" id="data" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500" required>
                        </div>
                        <div>
                            <label for="hora-inicial" class="block mb-2 text-sm font-medium text-gray-300">Hora Inicial</label>
                            <input type="time" id="hora-inicial" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500" required>
                        </div>
                        <div>
                            <label for="hora-final" class="block mb-2 text-sm font-medium text-gray-300">Hora Final</label>
                            <input type="time" id="hora-final" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500" required>
                        </div>
                         <div>
                            <label for="atividade-lancamento" class="block mb-2 text-sm font-medium text-gray-300">Atividade</label>
                            <select id="atividade-lancamento" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500" required>
                                <option value="">Selecione uma atividade</option>
                            </select>
                        </div>
                        <div>
                            <label for="funcionario-lancamento" class="block mb-2 text-sm font-medium text-gray-300">Funcionário Responsável</label>
                            <select id="funcionario-lancamento" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500" required>
                                <option value="">Selecione um funcionário</option>
                            </select>
                        </div>
                        <div>
                            <label for="transportadora-lancamento" class="block mb-2 text-sm font-medium text-gray-300">Transportadora</label>
                            <select id="transportadora-lancamento" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500" required>
                                <option value="">Selecione uma transportadora</option>
                            </select>
                        </div>
                        <div>
                            <label for="quantidade" class="block mb-2 text-sm font-medium text-gray-300">Quantidade</label>
                            <input type="number" id="quantidade" placeholder="Ex: 150" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500" required>
                        </div>
                        <div>
                            <label for="pausa" class="block mb-2 text-sm font-medium text-gray-300">Pausa (minutos)</label>
                            <input type="number" id="pausa" placeholder="Ex: 15" value="0" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500" required>
                        </div>
                         <div>
                            <label for="motivo-pausa" class="block mb-2 text-sm font-medium text-gray-300">Motivo da Pausa</label>
                            <input type="text" id="motivo-pausa" placeholder="Ex: Almoço, café" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">Adicionar Lançamento</button>
                        </div>
                    </form>
                </div>

                <div class="mt-10 bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 text-white">Histórico de Lançamentos</h2>
                    <div class="table-container">
                        <table class="w-full text-sm text-left text-gray-300">
                            <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0">
                                <tr>
                                    <th scope="col" class="py-3 px-6">Data</th>
                                    <th scope="col" class="py-3 px-6">Funcionário</th>
                                    <th scope="col" class="py-3 px-6">Atividade</th>
                                    <th scope="col" class="py-3 px-6">Qtd.</th>
                                    <th scope="col" class="py-3 px-6">Pausa (min)</th>
                                    <th scope="col" class="py-3 px-6">Tempo Líquido</th>
                                    <th scope="col" class="py-3 px-6">Produção/Hr</th>
                                    <th scope="col" class="py-3 px-6">Meta/Hr</th>
                                    <th scope="col" class="py-3 px-6">% Atingido</th>
                                    <th scope="col" class="py-3 px-6 no-print">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-lancamentos">
                                <!-- Linhas de lançamento serão inseridas aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Seção de Cadastros Gerais -->
            <div id="content-cadastros" class="hidden">
                 <!-- Cadastro de Atividades -->
                <div class="mb-12">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg no-print">
                            <h2 class="text-2xl font-bold mb-6 text-white border-b border-gray-700 pb-2">Nova Atividade</h2>
                            <form id="form-atividade">
                                <div class="mb-4">
                                    <label for="nome-atividade" class="block mb-2 text-sm font-medium text-gray-300">Nome da Atividade</label>
                                    <input type="text" id="nome-atividade" placeholder="Ex: Separação de Pedidos" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                                <div class="mb-6">
                                    <label for="meta-atividade" class="block mb-2 text-sm font-medium text-gray-300">Meta (peças/hora)</label>
                                    <input type="number" id="meta-atividade" placeholder="Ex: 100" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">Salvar Atividade</button>
                            </form>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-bold mb-4 text-white">Atividades Cadastradas</h2>
                            <div class="table-container">
                                <table class="w-full text-sm text-left text-gray-300">
                                    <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0">
                                        <tr>
                                            <th scope="col" class="py-3 px-6">Nome</th>
                                            <th scope="col" class="py-3 px-6">Meta/Hr</th>
                                            <th scope="col" class="py-3 px-6 no-print">Ação</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabela-atividades"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-8 border-gray-700">

                 <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Cadastro de Funcionários -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <div class="no-print">
                            <h2 class="text-2xl font-bold mb-6 text-white border-b border-gray-700 pb-2">Cadastro de Funcionários</h2>
                            <form id="form-funcionario">
                                <div class="mb-4">
                                    <label for="nome-funcionario" class="block mb-2 text-sm font-medium text-gray-300">Nome do Funcionário</label>
                                    <input type="text" id="nome-funcionario" placeholder="Ex: João da Silva" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">Salvar Funcionário</button>
                            </form>
                        </div>
                        <div class="mt-6 table-container">
                             <h2 class="text-2xl font-bold mb-4 text-white print:mt-0">Funcionários Cadastrados</h2>
                            <table class="w-full text-sm text-left text-gray-300">
                                <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0">
                                    <tr>
                                        <th scope="col" class="py-3 px-6">Nome</th>
                                        <th scope="col" class="py-3 px-6 no-print">Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-funcionarios"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Cadastro de Transportadoras -->
                     <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <div class="no-print">
                            <h2 class="text-2xl font-bold mb-6 text-white border-b border-gray-700 pb-2">Cadastro de Transportadoras</h2>
                            <form id="form-transportadora">
                                <div class="mb-4">
                                    <label for="nome-transportadora" class="block mb-2 text-sm font-medium text-gray-300">Nome da Transportadora</label>
                                    <input type="text" id="nome-transportadora" placeholder="Ex: Carga Rápida" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">Salvar Transportadora</button>
                            </form>
                        </div>
                         <div class="mt-6 table-container">
                            <h2 class="text-2xl font-bold mb-4 text-white">Transportadoras Cadastradas</h2>
                            <table class="w-full text-sm text-left text-gray-300">
                                <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0">
                                    <tr>
                                        <th scope="col" class="py-3 px-6">Nome</th>
                                        <th scope="col" class="py-3 px-6 no-print">Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-transportadoras"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção de Dashboards -->
            <div id="content-dashboards" class="hidden">
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8 no-print">
                    <h2 class="text-2xl font-bold mb-4 text-white">Filtros</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                             <label for="filtro-funcionario" class="block mb-2 text-sm font-medium text-gray-300">Funcionário</label>
                             <select id="filtro-funcionario" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="geral">Geral</option>
                             </select>
                        </div>
                        <div>
                             <label for="filtro-atividade-hist" class="block mb-2 text-sm font-medium text-gray-300">Atividade</label>
                             <select id="filtro-atividade-hist" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="geral">Geral</option>
                             </select>
                        </div>
                        <div>
                            <label for="filtro-data-inicio" class="block mb-2 text-sm font-medium text-gray-300">Data Início</label>
                            <input type="date" id="filtro-data-inicio" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                             <label for="filtro-data-fim" class="block mb-2 text-sm font-medium text-gray-300">Data Fim</label>
                             <input type="date" id="filtro-data-fim" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                </div>

                <div id="dashboard-charts-container">
                    <!-- Os gráficos serão gerados dinamicamente aqui -->
                </div>
            </div>
        </main>

    </div>

    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyB2GpqGN6nadQ0Xee3qR5uyeUwMqenteo8",
          authDomain: "controle-produtividade-exp.firebaseapp.com",
          projectId: "controle-produtividade-exp",
          storageBucket: "controle-produtividade-exp.firebasestorage.app",
          messagingSenderId: "887465393911",
          appId: "1:887465393911:web:eea4d17d445363c7161df2",
          measurementId: "G-JRP1YYN42J"
        };

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';


        // Elementos da UI
        const tabs = {
            lancamentos: document.getElementById('tab-lancamentos'),
            cadastros: document.getElementById('tab-cadastros'),
            dashboards: document.getElementById('tab-dashboards'),
        };
        const contents = {
            lancamentos: document.getElementById('content-lancamentos'),
            cadastros: document.getElementById('content-cadastros'),
            dashboards: document.getElementById('content-dashboards'),
        };
        
        // Formulários e Tabelas
        const formAtividade = document.getElementById('form-atividade'), nomeAtividadeInput = document.getElementById('nome-atividade'), metaAtividadeInput = document.getElementById('meta-atividade'), tabelaAtividades = document.getElementById('tabela-atividades');
        const formFuncionario = document.getElementById('form-funcionario'), nomeFuncionarioInput = document.getElementById('nome-funcionario'), tabelaFuncionarios = document.getElementById('tabela-funcionarios');
        const formTransportadora = document.getElementById('form-transportadora'), nomeTransportadoraInput = document.getElementById('nome-transportadora'), tabelaTransportadoras = document.getElementById('tabela-transportadoras');
        const formLancamento = document.getElementById('form-lancamento');
        const dataInput = document.getElementById('data'), horaInicialInput = document.getElementById('hora-inicial'), horaFinalInput = document.getElementById('hora-final');
        const atividadeLancamentoSelect = document.getElementById('atividade-lancamento'), funcionarioLancamentoSelect = document.getElementById('funcionario-lancamento'), transportadoraLancamentoSelect = document.getElementById('transportadora-lancamento');
        const quantidadeInput = document.getElementById('quantidade'), pausaInput = document.getElementById('pausa'), motivoPausaInput = document.getElementById('motivo-pausa');
        const tabelaLancamentos = document.getElementById('tabela-lancamentos');

        // Filtros Dashboard
        const filtroFuncionario = document.getElementById('filtro-funcionario'), filtroAtividadeHist = document.getElementById('filtro-atividade-hist');
        const filtroDataInicio = document.getElementById('filtro-data-inicio'), filtroDataFim = document.getElementById('filtro-data-fim');
        const dashboardChartsContainer = document.getElementById('dashboard-charts-container');
        const btnImprimir = document.getElementById('btn-imprimir');

        // Estado da Aplicação (cache local dos dados do Firestore)
        let atividades = [], funcionarios = [], transportadoras = [], lancamentos = [];
        let charts = {};
        let dbInitialized = false;

        // Referências das Coleções do Firestore
        const basePath = `artifacts/${appId}/public/data`;
        const atividadesCol = collection(db, `${basePath}/atividades`);
        const funcionariosCol = collection(db, `${basePath}/funcionarios`);
        const transportadorasCol = collection(db, `${basePath}/transportadoras`);
        const lancamentosCol = collection(db, `${basePath}/lancamentos`);
        
        // Autenticação e Inicialização
        onAuthStateChanged(auth, (user) => {
            if (user && !dbInitialized) {
                console.log("Usuário autenticado anonimamente:", user.uid);
                dbInitialized = true;
                setupRealtimeListeners();
                initUI();
            } else if (!user) {
                signInAnonymously(auth).catch((error) => console.error("Erro na autenticação anônima:", error));
            }
        });

        // Configura os listeners para atualizações em tempo real
        function setupRealtimeListeners() {
            onSnapshot(query(atividadesCol, orderBy("nome")), (snapshot) => {
                atividades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderizarAtividades();
                renderizarLancamentos();
                if (!contents.dashboards.classList.contains('hidden')) renderizarDashboards();
            }, (error) => console.error("Erro no listener de atividades:", error));

            onSnapshot(query(funcionariosCol, orderBy("nome")), (snapshot) => {
                funcionarios = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderizarFuncionarios();
                renderizarLancamentos();
                if (!contents.dashboards.classList.contains('hidden')) renderizarDashboards();
            }, (error) => console.error("Erro no listener de funcionários:", error));

            onSnapshot(query(transportadorasCol, orderBy("nome")), (snapshot) => {
                transportadoras = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderizarTransportadoras();
            }, (error) => console.error("Erro no listener de transportadoras:", error));

            onSnapshot(query(lancamentosCol), (snapshot) => {
                lancamentos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                lancamentos.sort((a, b) => {
                    const dateComparison = b.data.localeCompare(a.data);
                    if (dateComparison !== 0) return dateComparison;
                    return b.horaInicial.localeCompare(a.horaInicial);
                });

                renderizarLancamentos();
                if (!contents.dashboards.classList.contains('hidden')) renderizarDashboards();
            }, (error) => console.error("Erro no listener de lançamentos:", error));
        }
        
        // Funções de Renderização
        const renderGenericList = (tbody, items, emptyMessage, renderFn) => {
            tbody.innerHTML = '';
            if (items.length === 0) {
                const colSpan = tbody.previousElementSibling.firstElementChild.children.length;
                tbody.innerHTML = `<tr><td colspan="${colSpan}" class="text-center py-4 text-gray-500">${emptyMessage}</td></tr>`;
            } else {
                items.forEach(item => tbody.appendChild(renderFn(item)));
            }
        };
        
        const renderizarAtividades = () => {
            renderGenericList(tabelaAtividades, atividades, 'Nenhuma atividade cadastrada.', atividade => {
                const tr = document.createElement('tr'); tr.className = 'bg-gray-800 border-b border-gray-700';
                tr.innerHTML = `<td class="py-4 px-6 font-medium text-white">${atividade.nome}</td><td class="py-4 px-6">${atividade.meta}</td><td class="py-4 px-6 no-print"><button data-id="${atividade.id}" data-type="atividade" class="btn-excluir text-red-500 hover:text-red-700 font-semibold">Excluir</button></td>`; return tr;
            });
            atualizarDropdown(atividadeLancamentoSelect, atividades, 'atividade', false);
            atualizarDropdown(filtroAtividadeHist, atividades, 'atividade', true);
        };

        const renderizarFuncionarios = () => {
            renderGenericList(tabelaFuncionarios, funcionarios, 'Nenhum funcionário cadastrado.', f => {
                const tr = document.createElement('tr'); tr.className = 'bg-gray-800 border-b border-gray-700';
                tr.innerHTML = `<td class="py-4 px-6 font-medium text-white">${f.nome}</td><td class="py-4 px-6 no-print"><button data-id="${f.id}" data-type="funcionario" class="btn-excluir text-red-500 hover:text-red-700 font-semibold">Excluir</button></td>`; return tr;
            });
             atualizarDropdown(funcionarioLancamentoSelect, funcionarios, 'funcionário', false);
             atualizarDropdown(filtroFuncionario, funcionarios, 'funcionário', true);
        };

        const renderizarTransportadoras = () => {
            renderGenericList(tabelaTransportadoras, transportadoras, 'Nenhuma transportadora cadastrada.', t => {
                const tr = document.createElement('tr'); tr.className = 'bg-gray-800 border-b border-gray-700';
                tr.innerHTML = `<td class="py-4 px-6 font-medium text-white">${t.nome}</td><td class="py-4 px-6 no-print"><button data-id="${t.id}" data-type="transportadora" class="btn-excluir text-red-500 hover:text-red-700 font-semibold">Excluir</button></td>`; return tr;
            });
            atualizarDropdown(transportadoraLancamentoSelect, transportadoras, 'transportadora', false);
        };

        const renderizarLancamentos = () => {
             renderGenericList(tabelaLancamentos, lancamentos, 'Nenhum lançamento registrado.', l => {
                const atividade = atividades.find(a => a.id == l.atividadeId), funcionario = funcionarios.find(f => f.id == l.funcionarioId);
                const metaAtividade = atividade ? atividade.meta : 0, percentual = metaAtividade > 0 ? (l.producaoHora / metaAtividade) * 100 : 0;
                let corPercentual = 'text-yellow-400';
                if (percentual >= 100) corPercentual = 'text-green-400'; else if (percentual < 80) corPercentual = 'text-red-400';
                const tr = document.createElement('tr'); tr.className = 'bg-gray-800 border-b border-gray-700';
                tr.innerHTML = `
                    <td class="py-4 px-6">${new Date(l.data).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td>
                    <td class="py-4 px-6">${funcionario ? funcionario.nome : 'Excluído(a)'}</td>
                    <td class="py-4 px-6 font-medium text-white">${atividade ? atividade.nome : 'Excluída'}</td>
                    <td class="py-4 px-6">${l.quantidade}</td>
                    <td class="py-4 px-6" title="${l.motivoPausa || ''}">${l.pausaMinutos}</td>
                    <td class="py-4 px-6">${formatarTempo(l.tempoLiquido)}</td>
                    <td class="py-4 px-6">${l.producaoHora.toFixed(2)}</td>
                    <td class="py-4 px-6">${metaAtividade}</td>
                    <td class="py-4 px-6 font-bold ${corPercentual}">${percentual.toFixed(2)}%</td>
                    <td class="py-4 px-6 no-print"><button data-id="${l.id}" data-type="lancamento" class="btn-excluir text-red-500 hover:text-red-700 font-semibold">Excluir</button></td>`;
                return tr;
            });
        };
        
        const atualizarDropdown = (select, items, placeholder, comGeral) => {
            const valorAtual = select.value;
            select.innerHTML = comGeral ? `<option value="geral">Geral</option>` : `<option value="">Selecione um(a) ${placeholder}</option>`;
            items.forEach(item => select.innerHTML += `<option value="${item.id}">${item.nome}</option>`);
            select.value = valorAtual;
        };

        const formatarTempo = (ms) => {
            if (ms < 0) ms = 0;
            const h = Math.floor(ms / 3600000), m = Math.floor((ms % 3600000) / 60000), s = Math.floor(((ms % 3600000) % 60000) / 1000);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        };
        
        // Lógica de Dashboards
        const updateChart = (chartId, newConfig) => {
            if(charts[chartId]) charts[chartId].destroy();
            const ctx = document.getElementById(chartId)?.getContext('2d');
            if (ctx) {
                charts[chartId] = new Chart(ctx, newConfig);
            }
        };

        const renderizarDashboards = () => {
            const funcId = filtroFuncionario.value;
            const ativId = filtroAtividadeHist.value;
            const dataInicio = filtroDataInicio.value ? new Date(filtroDataInicio.value + 'T00:00:00') : null;
            const dataFim = filtroDataFim.value ? new Date(filtroDataFim.value + 'T23:59:59') : null;
            
            dashboardChartsContainer.innerHTML = '';

            const lancamentosFiltrados = lancamentos.filter(l => {
                const dataLancamento = new Date(l.data + 'T00:00:00');
                const filtroFuncOk = funcId === 'geral' || l.funcionarioId == funcId;
                const filtroDataInicioOk = !dataInicio || dataLancamento >= dataInicio;
                const filtroDataFimOk = !dataFim || dataLancamento <= dataFim;
                return filtroFuncOk && filtroDataInicioOk && filtroDataFimOk;
            });
            
            const atividadesParaMostrar = ativId === 'geral' 
                ? atividades 
                : atividades.filter(a => a.id === ativId);

            if (atividadesParaMostrar.length === 0) {
                dashboardChartsContainer.innerHTML = '<p class="text-center text-gray-500 mt-8">Nenhuma atividade para exibir ou dados no período selecionado.</p>';
                return;
            }

            atividadesParaMostrar.forEach(atividade => {
                const chartSection = document.createElement('div');
                chartSection.className = 'mb-12';
                chartSection.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4 text-white border-b border-gray-700 pb-2">${atividade.nome}</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-4">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <canvas id="desempenho-producao-chart-${atividade.id}"></canvas>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                             <canvas id="producao-geral-chart-${atividade.id}"></canvas>
                        </div>
                        <div class="lg:col-span-2 bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4 text-white">Histórico de Produção (Quantidade)</h3>
                            <canvas id="historico-chart-${atividade.id}"></canvas>
                        </div>
                    </div>
                `;
                dashboardChartsContainer.appendChild(chartSection);

                const lancamentosDaAtividade = lancamentosFiltrados.filter(l => l.atividadeId === atividade.id);
                
                setTimeout(() => {
                    renderDesempenhoProducaoChart(`desempenho-producao-chart-${atividade.id}`, lancamentosDaAtividade, atividade, funcId);
                    renderProducaoGeralChart(`producao-geral-chart-${atividade.id}`, lancamentosDaAtividade, atividade);
                    renderHistoricoProducaoChart(`historico-chart-${atividade.id}`, lancamentosDaAtividade);
                }, 0);
            });
        };
        
        const renderDesempenhoProducaoChart = (canvasId, dados, atividade, funcId) => {
            const dadosPorFuncionario = {};
            dados.forEach(l => {
                const func = funcionarios.find(f => f.id == l.funcionarioId);
                if (!func) return;
                if (!dadosPorFuncionario[func.nome]) {
                    dadosPorFuncionario[func.nome] = { produzido: 0, tempoHoras: 0 };
                }
                dadosPorFuncionario[func.nome].produzido += l.quantidade;
                dadosPorFuncionario[func.nome].tempoHoras += l.tempoLiquido / 3600000;
            });

            const labels = Object.keys(dadosPorFuncionario);
            const dataProduzido = labels.map(nome => dadosPorFuncionario[nome].produzido);
            const dataMeta = labels.map(nome => atividade.meta * dadosPorFuncionario[nome].tempoHoras);
            const dataPercentual = labels.map((nome, i) => dataMeta[i] > 0 ? (dataProduzido[i] / dataMeta[i]) * 100 : 0);

            let titleText = `Produção x Meta por Funcionário | Meta: ${atividade.meta}/hr`;
            if (funcId !== 'geral') {
                const funcNome = funcionarios.find(f => f.id == funcId)?.nome || 'Funcionário';
                titleText = `Desempenho ${funcNome} | Meta: ${atividade.meta}/hr`
            }

            const chartData = {
                labels,
                datasets: [
                    { type: 'bar', label: 'Total Produzido', data: dataProduzido, backgroundColor: 'rgba(79, 70, 229, 0.8)', yAxisID: 'y' },
                    { type: 'bar', label: 'Meta Esperada', data: dataMeta, backgroundColor: 'rgba(239, 68, 68, 0.8)', yAxisID: 'y' },
                    { type: 'line', label: '% Atingido', data: dataPercentual, borderColor: 'rgba(234, 179, 8, 1)', backgroundColor: 'rgba(234, 179, 8, 0.5)', yAxisID: 'y1', tension: 0.1 }
                ]
            };
            
            const chartOptions = {
                plugins: { 
                    legend: { labels: { color: '#d1d5db' } },
                    title: { display: true, text: titleText, color: '#d1d5db', font: { size: 16 } }
                },
                scales: {
                    x: { ticks: { color: '#d1d5db' } },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        ticks: { color: '#d1d5db' },
                        title: { display: true, text: 'Quantidade', color: '#d1d5db'}
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        ticks: { color: '#d1d5db', callback: value => value + '%' },
                        grid: { drawOnChartArea: false },
                        title: { display: true, text: '% Atingido', color: '#d1d5db'}
                    }
                }
            };
            
            updateChart(canvasId, { data: chartData, options: chartOptions });
        };

        const renderProducaoGeralChart = (canvasId, dados, atividade) => {
            const totalProduzido = dados.reduce((acc, l) => acc + l.quantidade, 0);
            const totalTempoHoras = dados.reduce((acc, l) => acc + l.tempoLiquido, 0) / 3600000;
            const metaEsperada = atividade.meta * totalTempoHoras;

             const chartData = {
                labels: ['Total Produzido', 'Meta Esperada'],
                datasets: [{
                    data: [totalProduzido, metaEsperada],
                    backgroundColor: ['rgba(79, 70, 229, 0.8)', 'rgba(239, 68, 68, 0.8)']
                }]
            };

            const chartOptions = {
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Produção Geral x Meta da Atividade', color: '#d1d5db', font: { size: 16 } }
                },
                scales: { 
                    y: { beginAtZero: true, ticks: { color: '#d1d5db' } }, 
                    x: { ticks: { color: '#d1d5db' } } 
                }
            };

            updateChart(canvasId, { type: 'bar', data: chartData, options: chartOptions });
        };


        const renderHistoricoProducaoChart = (canvasId, dados) => {
            const producaoPorDia = {};
            dados.forEach(l => { if(!producaoPorDia[l.data]) producaoPorDia[l.data] = 0; producaoPorDia[l.data] += l.quantidade; });
            const labels = Object.keys(producaoPorDia).sort((a,b) => new Date(a) - new Date(b));
            const data = labels.map(label => producaoPorDia[label]);
            updateChart(canvasId, { type: 'line', data: { labels, datasets: [{ label: 'Quantidade Produzida', data, borderColor: 'rgba(52, 211, 153, 1)', backgroundColor: 'rgba(52, 211, 153, 0.2)', fill: true, tension: 0.1 }] }, options: { scales: { y: { beginAtZero: true, ticks: { color: '#d1d5db' } },  x: { type: 'time', time: { unit: 'day' }, ticks: { color: '#d1d5db' } } }, plugins: { legend: { labels: { color: '#d1d5db' } } } } });
        };

        // Event Handlers
        Object.keys(tabs).forEach(key => tabs[key].addEventListener('click', () => {
            Object.keys(tabs).forEach(k => {
                const isSelected = k === key;
                tabs[k].classList.toggle('tab-active', isSelected); tabs[k].classList.toggle('tab-inactive', !isSelected);
                contents[k].classList.toggle('hidden', !isSelected);
            });
            if(key === 'dashboards') {
                initUIDashboards();
                renderizarDashboards();
            }
        }));
        
        [filtroFuncionario, filtroAtividadeHist, filtroDataInicio, filtroDataFim].forEach(el => el.addEventListener('change', renderizarDashboards));
        btnImprimir.addEventListener('click', () => window.print());

        formAtividade.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nome = nomeAtividadeInput.value.trim(); const meta = parseFloat(metaAtividadeInput.value);
            if (nome && !isNaN(meta)) {
                try { await addDoc(atividadesCol, { nome, meta }); formAtividade.reset(); } 
                catch (err) { console.error(err); alert("Erro ao salvar atividade."); }
            }
        });
        formFuncionario.addEventListener('submit', async (e) => {
            e.preventDefault(); const nome = nomeFuncionarioInput.value.trim();
            if (nome) {
                try { await addDoc(funcionariosCol, { nome }); formFuncionario.reset(); }
                catch (err) { console.error(err); alert("Erro ao salvar funcionário."); }
            }
        });
        formTransportadora.addEventListener('submit', async (e) => {
            e.preventDefault(); const nome = nomeTransportadoraInput.value.trim();
            if (nome) {
                try { await addDoc(transportadorasCol, { nome }); formTransportadora.reset(); }
                catch (err) { console.error(err); alert("Erro ao salvar transportadora."); }
            }
        });
        formLancamento.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = dataInput.value, horaInicial = horaInicialInput.value, horaFinal = horaFinalInput.value;
            const atividadeId = atividadeLancamentoSelect.value, funcionarioId = funcionarioLancamentoSelect.value, transportadoraId = transportadoraLancamentoSelect.value;
            const quantidade = parseInt(quantidadeInput.value), pausaMinutos = parseInt(pausaInput.value) || 0, motivoPausa = motivoPausaInput.value.trim();
            if (!data || !horaInicial || !horaFinal || !atividadeId || !funcionarioId || !transportadoraId || isNaN(quantidade)) { alert("Por favor, preencha todos os campos obrigatórios."); return; }
            const inicio = new Date(`${data}T${horaInicial}`), fim = new Date(`${data}T${horaFinal}`);
            if (fim <= inicio) { alert("A hora final deve ser maior que a hora inicial."); return; }
            const tempoTotalMs = fim - inicio, tempoPausaMs = pausaMinutos * 60 * 1000;
            if (tempoPausaMs >= tempoTotalMs) { alert("O tempo de pausa não pode ser maior ou igual ao tempo total."); return; }
            const tempoLiquidoMs = tempoTotalMs - tempoPausaMs, tempoLiquidoHoras = tempoLiquidoMs / 3600000;
            const producaoHora = tempoLiquidoHoras > 0 ? quantidade / tempoLiquidoHoras : 0;
            const novoLancamento = { data, horaInicial, horaFinal, atividadeId, funcionarioId, transportadoraId, quantidade, pausaMinutos, motivoPausa, tempoLiquido: tempoLiquidoMs, producaoHora };
            try {
                await addDoc(lancamentosCol, novoLancamento);
                formLancamento.reset(); pausaInput.value = 0; dataInput.value = new Date().toISOString().split('T')[0];
            } catch (err) { console.error(err); alert("Erro ao salvar lançamento."); }
        });
        
        document.querySelector('main').addEventListener('click', async (e) => {
            if (!e.target.classList.contains('btn-excluir')) return;
            const id = e.target.dataset.id, type = e.target.dataset.type;
            const colMap = { atividade: atividadesCol, funcionario: funcionariosCol, transportadora: transportadorasCol, lancamento: lancamentosCol };
            if (confirm(`Tem certeza que deseja excluir este item?`)) {
                try { await deleteDoc(doc(db, colMap[type].path, id)); } 
                catch (err) { console.error(err); alert(`Erro ao excluir ${type}.`); }
            }
        });
        
        let initialDashboardLoad = true;
        function initUIDashboards() {
            if (initialDashboardLoad) {
                const hoje = new Date();
                const formatDate = (date) => date.toISOString().split('T')[0];
                const hojeFormatado = formatDate(hoje);
                filtroDataFim.value = hojeFormatado;
                filtroDataInicio.value = hojeFormatado;
                initialDashboardLoad = false;
            }
        }

        const initUI = () => {
            const hojeFormatado = new Date().toISOString().split('T')[0];
            dataInput.value = hojeFormatado;
        };

    </script>
</body>
</html>

